<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 ç’€ç’¨è®°å¿†è·¨å¹´å¤œ</title>
    <style>
        :root { --gold: #d4af37; --white-soft: rgba(255,255,255,0.7); }
        body { margin: 0; background: #000; overflow: hidden; font-family: "Microsoft YaHei", sans-serif; color: white; }
        
        /* 1. å¯åŠ¨èƒŒæ™¯å±‚ */
        #startup-bg {
            position: fixed; inset: 0; z-index: 10; 
            background: linear-gradient(135deg, #1e0a3c 0%, #0a0e27 100%);
            transition: opacity 1s; pointer-events: none;
        }

        /* 2. UI ç•Œé¢ */
        #ui-layer {
            position: fixed; inset: 0; z-index: 100; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: transparent; transition: opacity 1s;
        }
        .btn-group { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; justify-content: center;}
        .custom-btn {
            padding: 15px 35px; border: 2px solid var(--gold); border-radius: 50px;
            background: rgba(0, 0, 0, 0.4); color: var(--gold); cursor: pointer;
            transition: all 0.3s; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(212,175,55,0.3); backdrop-filter: blur(5px); 
        }
        .custom-btn:hover {
            background: var(--gold); color: #000; box-shadow: 0 0 30px var(--gold); transform: scale(1.05);
        }
        .custom-btn:disabled {
            border-color: #666; color: #aaa; background: rgba(0,0,0,0.8); cursor: not-allowed; transform: none; box-shadow: none;
        }
        #start-btn {
            font-size: 1.8rem; margin-top: 50px; border-width: 3px; padding: 20px 50px;
            animation: pulse 2s infinite; backdrop-filter: blur(5px); background: rgba(0, 0, 0, 0.4);
        }
        #start-btn:hover {
            background: var(--gold); color: #000; box-shadow: 0 0 50px var(--gold); transform: scale(1.1);
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(212,175,55,0.3); }
            50% { box-shadow: 0 0 40px rgba(212,175,55,0.8); }
        }

        h1, p { text-shadow: 0 0 10px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5); text-align: center;}

        /* åª’ä½“å®¹å™¨ */
        #media-container { position: fixed; inset: 0; pointer-events: none; z-index: 20; overflow: hidden; }
        .floating-media {
            position: absolute; opacity: 0; transition: opacity 0.5s ease-in;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.2);
            filter: sepia(0.2) contrast(1.1);
        }
        .floating-lang {
            position: absolute; color: rgba(255,255,255,0.15); font-weight: bold;
            white-space: nowrap; pointer-events: none; font-size: 1.2rem;
        }

        /* ç”»å¸ƒä¸è£…é¥° */
        canvas { position: fixed; inset: 0; z-index: 30; pointer-events: none; }
        #upload-canvas { position: fixed; inset: 0; z-index: 40; pointer-events: none; }
        #decoration-layer { position: fixed; inset: 0; pointer-events: none; z-index: 35; }
        
        /* === ğŸˆ ä¸°å¯Œçš„åº•éƒ¨è£…é¥°åŠ¨ç”»æ ·å¼ === */
        .balloon {
            position: absolute; width: 60px; height: 75px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), var(--balloon-color));
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.3), 0 0 15px rgba(255,255,255,0.3);
            bottom: -150px; opacity: 0; animation: floatUp ease-in infinite;
        }
        .balloon::after {
            content: ''; position: absolute; bottom: -45px; left: 50%; width: 1px; height: 50px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.2));
            transform: translateX(-50%) rotate(0deg); animation: sway 3s ease-in-out infinite alternate;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8) rotate(0deg); opacity: 0; }
            10% { opacity: 0.95; transform: scale(1) rotate(0deg); }
            25% { transform: translateY(-10vh) rotate(2deg); }
            50% { transform: translateY(-40vh) rotate(-3deg) scale(0.95); }
            75% { transform: translateY(-70vh) rotate(1deg) scale(0.9); }
            100% { transform: translateY(-120vh) rotate(8deg) scale(0.85); opacity: 0; }
        }
        @keyframes sway {
            0% { transform: translateX(-50%) rotate(-8deg); height: 40px; }
            100% { transform: translateX(-50%) rotate(8deg); height: 50px; }
        }

        .upload-blessing {
            position: absolute; color: rgba(255,255,255,0.4); font-weight: bold; font-size: 1.5rem;
            animation: drift linear infinite; text-shadow: 0 0 8px rgba(255,255,255,0.3);
        }
        @keyframes drift {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.6; }
            100% { transform: translate(calc(100px * var(--dir-x)), -110vh) rotate(calc(10deg * var(--dir-y))); opacity: 0; }
        }

        /* === ğŸµ å®Œå…¨éšè—éŸ³ä¹æ’­æ”¾ç•Œé¢ï¼ˆä»…åå°æ’­æ”¾ï¼‰ === */
        #music-wrapper {
            position: fixed; top: -100px; left: -100px; z-index: -1; /* ç§»å‡ºå¯è§†åŒºåŸŸ */
            opacity: 0; pointer-events: none; /* é€æ˜ä¸”ä¸å¯ç‚¹å‡» */
            width: 1px; height: 1px; overflow: hidden; /* æœ€å°åŒ–å ç”¨ç©ºé—´ */
        }
        #music-summoner {
            display: none; /* å®Œå…¨éšè—å¬å”¤æŒ‰é’® */
        }
    </style>
</head>
<body>

    <div id="startup-bg"></div>

    <div id="ui-layer">
        <h1 style="color:var(--gold); font-size: 3rem; text-shadow: 0 0 20px rgba(212,175,55,0.5);">ğŸŠ 2026 ç’€ç’¨è®°å¿†è·¨å¹´å¤œ ğŸŠ</h1>
        <p id="main-hint" style="font-size: 1.3rem; color: rgba(255,255,255,0.8); margin-top: 20px;">âœ¨ ä¸Šä¼ æ‚¨çš„ç¾å¥½å›å¿†ï¼Œè®©å®ƒä»¬åœ¨çƒŸèŠ±ä¸­é—ªè€€ âœ¨</p>
        
        <div class="btn-group">
            <button class="custom-btn" onclick="document.getElementById('img-input').click()">ğŸ“¸ æ·»åŠ å›å¿†ç…§ç‰‡</button>
            <button class="custom-btn" onclick="document.getElementById('vid-input').click()">ğŸ¬ æ·»åŠ å›å¿†è§†é¢‘</button>
        </div>
        
        <input type="file" id="img-input" multiple accept="image/*" hidden>
        <input type="file" id="vid-input" multiple accept="video/*" hidden>
        
        <p id="upload-status" style="margin-top: 20px; color: var(--gold); font-size: 1.1rem; text-shadow: 0 0 5px #000000; min-height: 1.5em;"></p>
        
        <button id="start-btn" class="custom-btn">ğŸ† å¼€å¯ç’€ç’¨è·¨å¹´ ğŸ†</button>
    </div>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ï¼šå®Œå…¨éšè—ï¼Œä»…åå°æ’­æ”¾æ–°é“¾æ¥éŸ³é¢‘ -->
    <div id="music-wrapper">
        <div id="netease-iframe-container">
            <iframe 
                id="music-iframe" 
                frameborder="no" 
                border="0" 
                marginwidth="0" 
                marginheight="0" 
                width="330" 
                height="86"
                src="https://player.bilibili.com/player.html?bvid=BV1VjG9zsEhR&autoplay=1&loop=1&controls=0&muted=0&volume=100&high_quality=1&disable_page_scroll=1&enable_api=1&t=0"
                allow="autoplay; audio; clipboard-write; encrypted-media"
                allowfullscreen="false"
            ></iframe>
        </div>
    </div>

    <div id="decoration-layer"></div>
    <div id="media-container"></div>
    <canvas id="canvas"></canvas>
    <canvas id="upload-canvas"></canvas>

    <script>
        // ============================================================
        // âœ… Cloudinary é…ç½® (å·²ä¿ç•™ä½ çš„é…ç½®)
        // ============================================================
        const CLOUD_NAME = 'dhbod1bpw';
        const UPLOAD_PRESET = '2026NewYear';
        // ============================================================

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const mediaContainer = document.getElementById('media-container');
        const startBtn = document.getElementById('start-btn');
        const statusEl = document.getElementById('upload-status');
        const musicIframe = document.getElementById('music-iframe');
        
        let width, height;
        let particles = [], textParticles = [];
        let mediaElements = [];
        let mediaPool = []; 
        let displayedMedia = []; 
        const MAX_DISPLAYED = 9; 
        let sequenceIndex = 0;
        const sequence = ["5", "4", "3", "2", "1", "2026", "æ–°å¹´å¿«ä¹", "æ„¿æˆ‘ä»¬", "æ–°çš„ä¸€å¹´", "å¥½è¿+1", "å¹¸ç¦+1", "å¥åº·+1", "è´¢å¯Œ+âˆ", "å¹³å®‰å–œä¹", "ä¸‡äº‹é¡ºæ„"];
        
        let countdownInterval = null;
        let countdownElement = null;
        let isTransitioning = false;
        let musicStarted = false;

        // -----------------------------------------------------------
        // æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ†äº«ä¸ä¸Šä¼ 
        // -----------------------------------------------------------

        function checkShareLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('m'); 
            
            if (sharedData) {
                try {
                    const urls = JSON.parse(atob(sharedData));
                    console.log("æ”¶åˆ°åˆ†äº«çš„å›å¿†:", urls);
                    document.querySelector('.btn-group').style.display = 'none';
                    document.getElementById('main-hint').innerText = "âœ¨ æ”¶åˆ°äº†æ¥è‡ªæœ‹å‹çš„ç’€ç’¨å›å¿† âœ¨";
                    urls.forEach(url => {
                        const isVideo = url.match(/\.(mp4|webm|mov|mkv)$/i);
                        createMediaElement(url, isVideo ? 'video' : 'image');
                    });
                    statusEl.innerHTML = `ğŸ å·²åŠ è½½ ${urls.length} ä¸ªåˆ†äº«çš„å›å¿†<br><span style="font-size:0.8rem">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å¯</span>`;
                } catch (e) { console.error("è§£æåˆ†äº«é“¾æ¥å‡ºé”™:", e); }
            }
        }

        function generateShareLink() {
            if (mediaPool.length === 0) { alert("è¯·å…ˆä¸Šä¼ ç…§ç‰‡æˆ–è§†é¢‘å“¦ï¼"); return; }
            const urls = mediaPool.map(m => m.src);
            const code = btoa(JSON.stringify(urls));
            const shareUrl = `${window.location.origin}${window.location.pathname}?m=${code}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("ğŸ‰ é“¾æ¥å·²å¤åˆ¶ï¼\n\nå¿«å»å¾®ä¿¡ç²˜è´´å‘ç»™æœ‹å‹å§ï¼Œä»–ä»¬æ‰“å¼€å°±èƒ½çœ‹åˆ°è¿™äº›ç”»é¢ï¼");
            }).catch(() => { prompt("é•¿æŒ‰å¤åˆ¶é“¾æ¥åˆ†äº«ç»™æœ‹å‹ï¼š", shareUrl); });
        }

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET); 
            const resourceType = file.type.startsWith('video') ? 'video' : 'image';
            statusEl.innerText = `â³ æ­£åœ¨ä¸Šä¼  ${file.name}...`;

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`, {
                    method: 'POST', body: formData
                });
                const data = await res.json();
                if (data.secure_url) return { url: data.secure_url, type: resourceType };
                else throw new Error(data.error?.message || 'Upload failed');
            } catch (err) {
                console.error(err); alert(`ä¸Šä¼ å¤±è´¥: ${file.name}\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`); return null;
            }
        }

        async function handleFiles(e) {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;
            const btns = document.querySelectorAll('.custom-btn');
            btns.forEach(b => b.disabled = true);
            for (const file of files) {
                const result = await uploadToCloudinary(file);
                if (result) { createMediaElement(result.url, result.type); showMediaImmediately(); }
            }
            btns.forEach(b => b.disabled = false);
            if(mediaPool.length > 0) {
                statusEl.textContent = `âœ… å·²å°±ç»ª ${mediaPool.length} ä¸ªå›å¿†ç´ æ`;
                if (!document.getElementById('share-btn-dynamic')) {
                    const btnGroup = document.querySelector('.btn-group');
                    const shareBtn = document.createElement('button');
                    shareBtn.id = 'share-btn-dynamic'; shareBtn.className = 'custom-btn';
                    shareBtn.innerHTML = 'ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥'; shareBtn.onclick = generateShareLink;
                    shareBtn.style.borderColor = '#fff'; btnGroup.appendChild(shareBtn);
                }
            } else { statusEl.textContent = ''; }
        }

        document.getElementById('img-input').onchange = handleFiles;
        document.getElementById('vid-input').onchange = handleFiles;

        // -----------------------------------------------------------
        // ğŸµ éŸ³ä¹æ§åˆ¶é€»è¾‘ï¼ˆå®Œå…¨éšè—ï¼Œè‡ªåŠ¨æ’­æ”¾ï¼‰
        // -----------------------------------------------------------

        function createMediaElement(src, type) {
            const el = document.createElement(type === 'image' ? 'img' : 'video');
            el.src = src; el.crossOrigin = "Anonymous"; el.className = 'floating-media';
            if(type === 'video') { el.muted = true; el.loop = true; }
            mediaPool.push({ dom: el, type: type, isDisplayed: false, src: src });
        }

        // æ ¸å¿ƒï¼šç”¨æˆ·äº¤äº’åå¼ºåˆ¶å¯åŠ¨éŸ³ä¹ï¼ˆçªç ´æµè§ˆå™¨é™åˆ¶ï¼‰
        function forcePlayMusic() {
            if (musicStarted) return;
            musicStarted = true;

            // æ–¹æ¡ˆ1ï¼šåˆ·æ–°iframeå¼ºåˆ¶åŠ è½½å¹¶æ’­æ”¾
            let src = musicIframe.src;
            if (src.indexOf('&t=') > -1) src = src.split('&t=')[0];
            musicIframe.src = src + '&t=' + Date.now(); // åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜

            // æ–¹æ¡ˆ2ï¼šå‘é€Bç«™æ’­æ”¾å™¨APIå‘½ä»¤ï¼ˆå¤‡ç”¨ï¼‰
            setTimeout(() => {
                if (musicIframe.contentWindow) {
                    musicIframe.contentWindow.postMessage({
                        type: 'play',
                        data: {}
                    }, '*');
                }
            }, 800);
        }

        // ç›‘å¬é¡µé¢ä»»æ„äº¤äº’ï¼ˆç‚¹å‡»/è§¦æ‘¸/æŒ‰é”®ï¼‰ï¼Œè§¦å‘éŸ³ä¹æ’­æ”¾
        document.addEventListener('click', forcePlayMusic);
        document.addEventListener('touchstart', forcePlayMusic);
        window.addEventListener('keydown', forcePlayMusic);

        // ç›‘å¬iframeåŠ è½½å®Œæˆï¼Œè‡ªåŠ¨å°è¯•æ’­æ”¾
        musicIframe.onload = function() {
            setTimeout(() => {
                if (!musicStarted && musicIframe.contentWindow) {
                    musicIframe.contentWindow.postMessage({
                        type: 'play',
                        data: {}
                    }, '*');
                }
            }, 500);
        };

        document.addEventListener('click', (e) => {
            if (e.target.tagName !== 'IFRAME') window.focus();
        });

        // -----------------------------------------------------------
        // ğŸˆ ä¸°å¯Œçš„èƒŒæ™¯è£…é¥°é€»è¾‘ (æ°”çƒ+æ¼‚æµ®ç¥ç¦)
        // -----------------------------------------------------------

        function spawnDecorations() {
            const container = document.getElementById('decoration-layer');
            if(!container) return;

            // 1. æ°”çƒ
            const balloonColors = ['#ffd700', '#ff4500', '#ff6b9d', '#4d88ff', '#9d4edd', '#ffaa33'];
            for(let i = 0; i < 25; i++) {
                const balloon = document.createElement('div'); balloon.className = 'balloon';
                balloon.style.left = Math.random() * 100 + '%'; balloon.style.bottom = '-150px';
                balloon.style.setProperty('--balloon-color', balloonColors[Math.floor(Math.random() * balloonColors.length)]);
                balloon.style.animationDelay = Math.random() * 2 + 's'; 
                balloon.style.animationDuration = Math.random() * 4 + 10 + 's'; 
                balloon.style.width = (Math.random() * 20 + 50) + 'px'; balloon.style.height = (Math.random() * 20 + 65) + 'px';
                container.appendChild(balloon);
            }

            // 2. æ¼‚æµ®æ–‡å­—
            const blessings = ["Happy New Year", "æ–°å¹´å¿«ä¹", "Bonne AnnÃ©e", "Feliz AÃ±o Nuevo","â¤ï¸","ğŸ’–", "ğŸŠ", "ğŸ‰", "âœ¨", "ğŸ†", "ğŸˆ", "2026", "ç¦", "æ¨‚", "è´¢", "å®‰", "åº·", "é¡º", "ç™¼", "æ—º", "ğŸ‡", "ğŸ§§", "ğŸ®"];
            for(let i = 0; i < 30; i++) {
                const blessing = document.createElement('div'); blessing.className = 'upload-blessing';
                blessing.textContent = blessings[Math.floor(Math.random() * blessings.length)];
                blessing.style.left = Math.random() * 100 + '%'; blessing.style.bottom = '0px';
                blessing.style.setProperty('--dir-x', Math.random() > 0.5 ? 1 : -1); blessing.style.setProperty('--dir-y', Math.random() > 0.5 ? 1 : -1);
                blessing.style.fontSize = (Math.random() * 20 + 16) + 'px'; blessing.style.color = `rgba(255, ${Math.random() * 155 + 100}, ${Math.random() * 100}, 0.7)`;
                blessing.style.animationDuration = (Math.random() * 5 + 12) + 's'; blessing.style.animationDelay = Math.random() * 3 + 's'; blessing.style.opacity = '0';
                container.appendChild(blessing);
            }
            
            // 3. æ¼‚æµ®ç¬¦å·
            const symbols = ['ğŸˆ', 'âœ¨', 'ğŸ‡', 'ğŸ§¨', 'ğŸ', 'ğŸ€', 'ğŸ—ï¸', 'ğŸ†', 'ğŸ¥‡', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸŒˆ', 'â˜„ï¸', 'ğŸŒ ', 'ğŸ„', 'ğŸ‹', 'ğŸ', 'ğŸ', 'ğŸ'];
            for(let i = 0; i < 15; i++) {
                const symbol = document.createElement('div'); symbol.className = 'upload-blessing';
                symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                symbol.style.left = Math.random() * 100 + '%'; symbol.style.bottom = '0px';
                symbol.style.setProperty('--dir-x', Math.random() > 0.5 ? 1 : -1); symbol.style.setProperty('--dir-y', Math.random() > 0.5 ? 1 : -1);
                symbol.style.fontSize = (Math.random() * 30 + 20) + 'px'; symbol.style.animationDuration = (Math.random() * 4 + 8) + 's';
                symbol.style.animationDelay = Math.random() * 2 + 's'; symbol.style.opacity = '0';
                container.appendChild(symbol);
            }
        }

        // -----------------------------------------------------------
        // åŠ¨ç”»é€»è¾‘
        // -----------------------------------------------------------

        function initNewYearCountdown() {
            if (countdownElement) return;
            countdownElement = document.createElement('div');
            countdownElement.id = 'new-year-countdown';
            countdownElement.style.cssText = `
                position: fixed; top: 20px; right: 20px; color: #ffd700; font-size: 1.5rem; font-weight: bold;
                text-shadow: 0 0 10px rgba(255,215,0,0.5); z-index: 2000; background: rgba(0,0,0,0.6);
                padding: 10px 20px; border-radius: 10px; border: 2px solid rgba(255,215,0,0.3);
                display: block; box-shadow: 0 0 20px rgba(212,175,55,0.2); font-family: 'Microsoft YaHei', sans-serif;
            `;
            document.body.appendChild(countdownElement);
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function updateCountdown() {
            const now = new Date();
            const nextNewYear = new Date(2026, 0, 1, 0, 0, 0, 0);
            const diff = nextNewYear - now;
            if (diff > 0 && diff <= 5300 && !isTransitioning) startBtn.click();
            if (diff <= 0) {
                if (countdownElement) {
                    countdownElement.textContent = "ğŸ‰ 2026 å…ƒæ—¦å¿«ä¹ï¼ğŸ‰";
                    countdownElement.style.color = '#ff4500';
                }
                if (countdownInterval) clearInterval(countdownInterval);
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            if (countdownElement) countdownElement.textContent = `2026 å€’è®¡æ—¶: ${days}å¤© ${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        }

        function toggleCountdown(show) {
            if (countdownElement) countdownElement.style.display = show ? 'block' : 'none';
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function showMedia(mediaItem) {
            if(mediaItem.isDisplayed) return;
            const el = mediaItem.dom;
            if(mediaItem.type === 'video') { el.muted = true; el.loop = true; el.play().catch(e => {}); }
            const size = Math.random() * 150 + 100;
            const leftPos = Math.random() * 80 + 10;
            const topPos = Math.random() * 80 + 10;
            el.style.width = size + 'px'; el.style.left = leftPos + '%'; el.style.top = topPos + '%';
            el.style.transform = `rotate(${(Math.random()-0.5)*40}deg)`; el.style.opacity = '0'; el.style.position = 'absolute';
            mediaContainer.appendChild(el);
            const mediaObj = { dom: el, mediaItem: mediaItem, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, x: leftPos, y: topPos };
            mediaElements.push(mediaObj); displayedMedia.push(mediaObj); mediaItem.isDisplayed = true;
            el.offsetHeight; 
            requestAnimationFrame(() => { el.style.opacity = '0.7'; });
            startFloatingAnimation();
        }

        let floatingInterval = null;
        function startFloatingAnimation() {
            if(floatingInterval) return; 
            floatingInterval = setInterval(() => {
                mediaElements.forEach(m => {
                    if(!m.mediaItem) return;
                    m.x += m.vx; m.y += m.vy;
                    if(m.x < 0 || m.x > 90) m.vx *= -1; if(m.y < 0 || m.y > 90) m.vy *= -1;
                    m.dom.style.left = m.x + '%'; m.dom.style.top = m.y + '%';
                });
            }, 30);
        }

        function hideMedia(mediaObj) {
            mediaObj.dom.style.opacity = 0;
            setTimeout(() => {
                if(mediaObj.dom.parentNode) mediaObj.dom.parentNode.removeChild(mediaObj.dom);
                mediaObj.mediaItem.isDisplayed = false;
            }, 2000);
            const idx1 = mediaElements.indexOf(mediaObj); if(idx1 > -1) mediaElements.splice(idx1, 1);
            const idx2 = displayedMedia.indexOf(mediaObj); if(idx2 > -1) displayedMedia.splice(idx2, 1);
        }

        function rotateMedia() {
            if(mediaPool.length === 0) return;
            while(displayedMedia.length < Math.min(MAX_DISPLAYED, mediaPool.length)) {
                const available = mediaPool.filter(m => !m.isDisplayed);
                if(available.length > 0) showMedia(available[Math.floor(Math.random() * available.length)]);
                else break;
            }
            if(mediaPool.length > MAX_DISPLAYED && displayedMedia.length > 0) {
                hideMedia(displayedMedia[0]);
                setTimeout(() => {
                    const available = mediaPool.filter(m => !m.isDisplayed);
                    if(available.length > 0) showMedia(available[Math.floor(Math.random() * available.length)]);
                }, 1000);
            }
        }

        function showMediaImmediately() {
            const available = mediaPool.filter(m => !m.isDisplayed);
            if(available.length > 0) {
                for(let i = 0; i < Math.min(available.length, MAX_DISPLAYED - displayedMedia.length); i++) {
                    showMedia(available[i]);
                }
            }
        }

        function initBackgroundText() {
            const languages = ["Happy New Year", "2026", "æ–°å¹´å¿«ä¹", "ä¸‡äº‹é¡ºæ„", "å¹³å®‰å–œä¹", "å²å²å¹³å®‰"];
            languages.forEach(text => {
                const el = document.createElement('div'); el.className = 'floating-lang'; el.innerText = text;
                el.style.left = Math.random() * 80 + '%'; el.style.top = Math.random() * 80 + '%';
                mediaContainer.appendChild(el);
                mediaElements.push({ dom: el, vx: (Math.random() - 0.5) * 0.3, vy: (Math.random() - 0.5) * 0.3, x: parseFloat(el.style.left), y: parseFloat(el.style.top) });
            });
        }

        class Particle {
            constructor(x, y, hue, isText, targetX, targetY) {
                this.x = x; this.y = y; this.hue = hue;
                this.isText = isText; this.targetX = targetX; this.targetY = targetY;
                this.alpha = 1; this.decay = Math.random() * 0.008 + 0.005;
                this.velocity = { x: (Math.random()-0.5)*6, y: (Math.random()-0.5)*6 };
                this.size = this.isText ? 1.5 : (Math.random() * 3 + 1.5);
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${this.hue}, 50%, ${this.isText ? 80 : 50}%, ${this.alpha})`; ctx.fill();
            }
            update() {
                if(this.isText) { this.x += (this.targetX - this.x) * 0.08; this.y += (this.targetY - this.y) * 0.08; }
                else { this.velocity.y += 0.03; this.x += this.velocity.x * 0.8; this.y += this.velocity.y * 0.8; this.alpha -= this.decay; }
            }
        }

        function getTextPoints(text) {
            const tempCanvas = document.createElement('canvas'); const tCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width; tempCanvas.height = height;
            const size = Math.min(width/4, 200); tCtx.font = `bold ${size}px Arial`; 
            tCtx.textAlign = 'center'; tCtx.textBaseline = 'middle'; tCtx.fillText(text, width/2, height/2);
            const data = tCtx.getImageData(0,0,width,height).data;
            const points = []; const gap = 5; 
            for(let y=0; y<height; y+=gap) for(let x=0; x<width; x+=gap) if(data[(y*width+x)*4+3] > 250) points.push({x,y});
            return points;
        }

        function createTextFirework(text) {
            const pts = getTextPoints(text);
            textParticles = pts.map(p => new Particle(width/2, height, Math.random()>0.5?350:45, true, p.x, p.y));
            for(let i=0; i<2; i++) setTimeout(() => {
                const x=Math.random()*width, y=Math.random()*height/2; 
                for(let j=0; j<80; j++) particles.push(new Particle(x, y, Math.random()*360, false));
            }, i*200);
        }

        function loop() {
            ctx.globalCompositeOperation = 'destination-out'; ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'lighter';
            mediaElements.forEach(m => {
                m.x += m.vx; m.y += m.vy;
                if(m.x < 0 || m.x > 90) m.vx *= -1; if(m.y < 0 || m.y > 90) m.vy *= -1;
                m.dom.style.left = m.x + '%'; m.dom.style.top = m.y + '%';
            });
            particles = particles.filter(p => p.alpha > 0); particles.forEach(p => { p.update(); p.draw(); });
            textParticles.forEach(p => { p.update(); p.draw(); });
            if(sequenceIndex >= 5 && Math.random() < 0.08) {
                const x=Math.random()*width, y=Math.random()*height/2; for(let i=0; i<80; i++) particles.push(new Particle(x, y, Math.random()*360, false));
            }
            requestAnimationFrame(loop);
        }

        function runSequence() {
            if(sequenceIndex < sequence.length) {
                const text = sequence[sequenceIndex]; 
                createTextFirework(text);
                // æ˜¾ç¤º2026æ—¶ï¼Œå¯åŠ¨è£…é¥°
                if(text === "2026") spawnDecorations();
                sequenceIndex++;
                if(text === "ä¸‡äº‹é¡ºæ„") setTimeout(() => { textParticles = []; }, 3000);
                setTimeout(runSequence, sequenceIndex <= 5 ? 1200 : 2500);
            }
        }
        
        let uploadFireworks = []; let uploadAnimating = true;
        function startUploadFireworks() {
            const uploadCanvas = document.getElementById('upload-canvas'); const uploadCtx = uploadCanvas.getContext('2d');
            uploadCanvas.width = window.innerWidth; uploadCanvas.height = window.innerHeight;
            function animate() {
                if(!uploadAnimating) return;
                uploadCtx.globalCompositeOperation = 'destination-out'; uploadCtx.fillStyle = 'rgba(0,0,0,0.15)';
                uploadCtx.fillRect(0, 0, uploadCanvas.width, uploadCanvas.height); uploadCtx.globalCompositeOperation = 'lighter';
                if(Math.random() < 0.03) {
                    const x=Math.random()*uploadCanvas.width, y=Math.random()*uploadCanvas.height*0.6;
                    for(let i=0; i<60; i++) uploadFireworks.push(new Particle(x, y, Math.random()*360, false));
                }
                uploadFireworks = uploadFireworks.filter(p => p.alpha > 0);
                uploadFireworks.forEach(p => { p.update(); uploadCtx.beginPath(); uploadCtx.arc(p.x, p.y, p.size, 0, Math.PI*2); uploadCtx.fillStyle = `hsla(${p.hue},100%,60%,${p.alpha})`; uploadCtx.fill(); });
                requestAnimationFrame(animate);
            }
            animate();
        }

        function initUploadDecorations() {
            // åœ¨ä¸Šä¼ ç•Œé¢ä¹Ÿç¨å¾®æ˜¾ç¤ºä¸€ç‚¹è£…é¥°ï¼Œå¢åŠ æ°›å›´
            spawnDecorations();
            startUploadFireworks();
        }

        window.addEventListener('load', () => { 
            checkShareLink();
            initUploadDecorations();
            initNewYearCountdown(); 
            toggleCountdown(true); 
        });

        startBtn.onclick = () => {
            forcePlayMusic(); // ç‚¹å‡»å¼€å¯è·¨å¹´æ—¶å¼ºåˆ¶å¯åŠ¨éŸ³ä¹
            if(isTransitioning) return;
            isTransitioning = true;
            uploadAnimating = false;
            window.focus();
            if(floatingInterval) { clearInterval(floatingInterval); floatingInterval = null; }
            
            // æ¸…ç©ºæ—§çš„è£…é¥°ï¼Œå‡†å¤‡æ–°çš„
            document.getElementById('decoration-layer').innerHTML = '';
            
            document.getElementById('ui-layer').style.opacity = 0;
            document.getElementById('startup-bg').style.opacity = 0; 
            toggleCountdown(false);

            setTimeout(() => { 
                document.getElementById('ui-layer').remove(); 
                document.getElementById('startup-bg').remove(); 
                document.getElementById('upload-canvas').style.display = 'none'; 
            }, 1000);
            
            initBackgroundText(); loop(); runSequence(); rotateMedia();
            setInterval(() => { rotateMedia(); }, 3000);
        };
    </script>
</body>
</html>